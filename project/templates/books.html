<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <title>Books Management</title>
</head>

<body>
    <a href="/loans">Go to Loans Page</a>
    <a href="/customers">Go to Customers Page</a>
    <div class="container mt-4">
        <h1>Books Management</h1>
        <div class="mb-3">
            <input type="text" id="name" placeholder="Name">
            <input type="text" id="author" placeholder="Author">
            <input type="text" id="year_published" placeholder="Year Published">
            <input type="text" id="book_type" placeholder="Book Type">
            <button class="btn btn-primary" onclick="add_book()">Add</button>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Book ID</th>
                    <th>Name</th>
                    <th>Author</th>
                    <th>Year Published</th>
                    <th>Book Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="book-list">
                <!-- Book data will be displayed here -->
            </tbody>
        </table>
    </div>

    <script>
        const MY_SERVER = 'http://127.0.0.1:5000/books';
        const bookList = document.getElementById('book-list');

       
        

        const get_data = async () => {
            try {
                const res = await axios.get(`${MY_SERVER}/get`);
                bookList.innerHTML = res.data.map(book => `
                    <tr id="book-${book.id}"> <!-- Add a unique identifier (e.g., book ID) to the row -->
                        <td>${book.id}</td> <!-- Display the Book ID -->
                        <td>${book.name}</td>
                        <td>${book.author}</td>
                        <td>${book.year_published}</td>
                        <td>${book.book_type}</td>
                        <td>
                            <button class='btn btn-danger' onClick='del_book(${book.id})'>Delete</button>
                            <button class='btn btn-info' onClick='edit_book(${book.id})'>Edit</button> <!-- Add an edit action -->
                        </td>
                    </tr>`
                ).join('');
            } catch (error) {
                console.error(error);
            }
        }
        const yearPublishedElement = document.getElementById('year_published');
        const bookTypeElement = document.getElementById('book_type');

        yearPublishedElement.addEventListener('change', function () {
            const yearPublishedValue = yearPublishedElement.value;
            if (!/^\d+$/.test(yearPublishedValue)) {
                alert('Year Published must be a valid number.');
                yearPublishedElement.value = ''; // Clear the input
            }
        });

        bookTypeElement.addEventListener('change', function () {
            const bookTypeValue = bookTypeElement.value;
            if (bookTypeValue !== '1' && bookTypeValue !== '2' && bookTypeValue !== '3') {
                alert('Book Type must be 1, 2, or 3.');
                bookTypeElement.value = ''; // Clear the input
            }
        });

        const clearFields = () => {
            const inputFields = ["name", "author", "year_published", "book_type"];
            inputFields.forEach(field => document.getElementById(field).value = '');
        }

        const add_book = () => {
            const nameElement = document.getElementById('name');
            const authorElement = document.getElementById('author');
            const yearPublishedElement = document.getElementById('year_published');
            const bookTypeElement = document.getElementById('book_type');

            const nameValue = nameElement.value;
            const authorValue = authorElement.value;
            const yearPublishedValue = yearPublishedElement.value;
            const bookTypeValue = bookTypeElement.value;

            if (!nameValue || !authorValue || !yearPublishedValue || !bookTypeValue) {
                alert('Please fill in all fields');
                return;
            }
            const bookData = {
                name: nameValue,
                author: authorValue,
                year_published: yearPublishedValue,
                book_type: bookTypeValue,
            };
            axios.post(`${MY_SERVER}/add`, bookData)
                .then(() => {
                    clearFields();
                    get_data();
                })
                .catch(err => {
                    console.error(err);
                });
        }

        async function del_book(id) {
            try {
                await axios.delete(`${MY_SERVER}/remove/${id}`);
                get_data();
            } catch (error) {
                console.error(error);
            }
        }

        async function edit_book(id) {
            const row = document.getElementById(`book-${id}`);
            const nameElement = row.cells[0];
            const authorElement = row.cells[1];
            const yearPublishedElement = row.cells[2];
            const bookTypeElement = row.cells[3];
            const editButton = row.cells[4].querySelector('.btn-info');

            // Convert the row's cells into input fields
            nameElement.innerHTML = `<input type="text" value="${nameElement.innerText}">`;
            authorElement.innerHTML = `<input type="text" value="${authorElement.innerText}">`;
            yearPublishedElement.innerHTML = `<input type="text" value="${yearPublishedElement.innerText}">`;
            bookTypeElement.innerHTML = `<input type="text" value="${bookTypeElement.innerText}">`;

            // Change the Edit button to Update
            editButton.innerText = 'Update';
            editButton.onclick = () => update_book(id, row); // Set the update function
        }

        // Function to update a book
        async function update_book(id, row) {
            const nameElement = row.cells[0].querySelector('input');
            const authorElement = row.cells[1].querySelector('input');
            const yearPublishedElement = row.cells[2].querySelector('input');
            const bookTypeElement = row.cells[3].querySelector('input');

            const nameValue = nameElement.value;
            const authorValue = authorElement.value;
            const yearPublishedValue = yearPublishedElement.value;
            const bookTypeValue = bookTypeElement.value;

            if (!nameValue || !authorValue || !yearPublishedValue || !bookTypeValue) {
                alert('Please fill in all fields');
                return;
            }

            const bookData = {
                name: nameValue,
                author: authorValue,
                year_published: yearPublishedValue,
                book_type: bookTypeValue,
            };

            axios.put(`${MY_SERVER}/update/${id}`, bookData)
                .then(() => {
                    // Convert input fields back to plain text
                    nameElement.outerHTML = nameValue;
                    authorElement.outerHTML = authorValue;
                    yearPublishedElement.outerHTML = yearPublishedValue;
                    bookTypeElement.outerHTML = bookTypeValue;

                    // Change the Update button back to Edit
                    const editButton = row.cells[4].querySelector('.btn-info');
                    editButton.innerText = 'Edit';
                    editButton.onclick = () => edit_book(id);

                    get_data();
                })
                .catch(err => {
                    console.error(err);
                });
        }



        get_data();
    </script>
</body>

</html>